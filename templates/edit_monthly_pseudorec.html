{% load static %}
<link rel="stylesheet" href="{% static 'css/monthly_pseudorec_add_edit.css' %}">

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <label for="id_title">ì œëª©:</label>
    <input type="text" name="title" value="{{ post.title }}" required>

    <label for="id_subtitle">ë¶€ì œëª©:</label>
    <input type="text" name="subtitle" value="{{ post.subtitle }}">

    <label for="id_month">ë°œí–‰ ì›”:</label>
    <input type="text" name="month" value="{{ post.month }}" required>

    <label for="id_content">ë‚´ìš©:</label>
    <textarea id="content_editor" name="content" rows="10">{{ post.content }}</textarea>

    <!-- ğŸ”¹ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì‚½ì… -->
    <label for="upload_content_image">ë³¸ë¬¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ:</label>
    <div class="image_upload_section">
        <input type="file" id="upload_content_image" accept="image/*">
        <button type="button" id="upload_content_btn">ì—…ë¡œë“œ</button>
        <div id="content_image_preview_container">
            <img id="content_upload_preview" src="#" alt="ë¯¸ë¦¬ë³´ê¸°" style="display:none; width:200px; margin-top:10px;" />
        </div>
    </div>

    <label>ë³¸ë¬¸ ì‚½ì… ê°€ëŠ¥í•œ ê¸°ì¡´ ì´ë¯¸ì§€:</label>
    <div id="content_image_gallery" style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for image in s3_images %}
        <img src="{{ image }}" onclick="insertImage('{{ image }}')"
            style="width: 100px; height: auto; cursor: pointer; border: 2px solid transparent;">
        {% endfor %}
    </div>

    <label for="upload_card_image">ì¹´ë“œ ì´ë¯¸ì§€:</label>
    <div class="card_image_select">
        <span>ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
        <input type="file" id="upload_card_image" accept="image/*">
        <button type="button" id="upload_btn">ì—…ë¡œë“œ</button>
        <div id="preview_container">
            <img id="upload_preview" src="#" alt="ë¯¸ë¦¬ë³´ê¸°" style="display:none; width:200px; margin-top:10px;" />
        </div>
    </div>

    <label>ê¸°ì¡´ ì¹´ë“œ ì´ë¯¸ì§€ ì„ íƒ:</label>
    <div id="image_gallery" style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for image in s3_images %}
        <img src="{{ image }}" onclick="selectCardImage('{{ image }}', this)"
            style="width: 100px; height: auto; cursor: pointer; border: 2px solid transparent;">
        {% endfor %}
    </div>

    <input type="hidden" name="selected_card_image" id="selected_card_image_hidden">
    <img id="selected_card_image_preview" src="{% if post.card_image %}{{ post.card_image }}{% endif %}"
        alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"
        style="max-width: 300px; display: {% if post.card_image %}block{% else %}none{% endif %}; margin-top: 10px;">

    <label for="id_author">ì‘ì„±ì:</label>
    <input type="text" name="author" value="{{ post.author }}" required>

    <label for="id_author_image">ì‘ì„±ì ì´ë¯¸ì§€ ì—…ë¡œë“œ:</label>
    <input type="file" name="author_image">

    <label for="id_tag1">íƒœê·¸ 1:</label>
    <input type="text" name="tag1" value="{{ post.tag1 }}">

    <label for="id_tag2">íƒœê·¸ 2:</label>
    <input type="text" name="tag2" value="{{ post.tag2 }}">

    <label for="id_created_at">ì‘ì„±ì¼:</label>
    <input type="datetime-local" name="created_at" value="{{ post.created_at|date:'Y-m-d\TH:i' }}">

    <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
</form>

<script>
    // ğŸ”¹ ë³¸ë¬¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById("upload_content_image").addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById("content_upload_preview").src = e.target.result;
                document.getElementById("content_upload_preview").style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    // ğŸ”¹ ë³¸ë¬¸ ì´ë¯¸ì§€ S3 ì—…ë¡œë“œ
    document.getElementById("upload_content_btn").addEventListener("click", function () {
        const fileInput = document.getElementById("upload_content_image");
        if (fileInput.files.length === 0) {
            alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const formData = new FormData();
        formData.append("image", fileInput.files[0]);

        fetch("{% url 'upload_image_ajax' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.image_url) {
                alert("ì—…ë¡œë“œ ì™„ë£Œ!");

                // ë³¸ë¬¸ ì‚½ì… ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ëª©ë¡ì— ì¶”ê°€
                const gallery = document.getElementById("content_image_gallery");
                const newImg = document.createElement("img");
                newImg.src = data.image_url;
                newImg.style = "width: 100px; height: auto; cursor: pointer; border: 2px solid transparent;";
                newImg.onclick = function () { insertImage(data.image_url); };
                gallery.appendChild(newImg);
            } else {
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + data.error);
            }
        })
        .catch(error => {
            console.error("Error uploading image:", error);
            alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        });
    });

    // ğŸ”¹ ë³¸ë¬¸ì— ì´ë¯¸ì§€ ì‚½ì…
    function insertImage(imageUrl) {
        const editor = document.getElementById("content_editor");
        const cursorPosition = editor.selectionStart;
        const textBefore = editor.value.substring(0, cursorPosition);
        const textAfter = editor.value.substring(cursorPosition);
        
        // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ ì‚½ì…
        editor.value = textBefore + `\n\n![ì´ë¯¸ì§€](${imageUrl})\n\n` + textAfter;
        editor.focus();
    }

    // ğŸ”¹ ì¹´ë“œ ì´ë¯¸ì§€ ì„ íƒ
    function selectCardImage(imageUrl, imgElement) {
        document.getElementById("selected_card_image_hidden").value = imageUrl;
        document.getElementById("selected_card_image_preview").src = imageUrl;
        document.getElementById("selected_card_image_preview").style.display = "block";

        // ëª¨ë“  ì´ë¯¸ì§€ í…Œë‘ë¦¬ ì´ˆê¸°í™”
        document.querySelectorAll("#image_gallery img").forEach(img => img.style.border = "2px solid transparent");

        // ì„ íƒëœ ì´ë¯¸ì§€ ê°•ì¡°
        imgElement.style.border = "2px solid blue";
    }
</script>
