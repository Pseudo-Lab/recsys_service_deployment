{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Assistant Agent Architecture</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 0;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-weight: 700;
        }
        .architecture-section {
            margin-bottom: 50px;
        }
        .architecture-section h2 {
            color: #764ba2;
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }
        .mermaid {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .description {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .agent-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .agent-card h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .agent-card p {
            font-size: 0.9rem;
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        {% include 'navbar.html' %}
    </header>

    <div class="container">
        <h1><i class="fas fa-project-diagram"></i> Trading Assistant Agent Architecture</h1>

        <!-- Overall System Flow -->
        <div class="architecture-section">
            <h2>1. Overall System Flow</h2>
            <div class="description">
                <strong>Multi-Agent System:</strong> 4ê°œì˜ ë¶„ì„ ì—ì´ì „íŠ¸ê°€ ì‹œì¥ì„ ë¶„ì„í•˜ê³ , íˆ¬ì í† ë¡ ê³¼ ë¦¬ìŠ¤í¬ í† ë¡ ì„ ê±°ì³ ìµœì¢… íˆ¬ì ê³„íšì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.
            </div>

            <div class="mermaid">
graph TB
    Start([User Input: Ticker & Date]) --> Init[Initialize Graph]
    Init --> Analysts{4 Analysts}

    Analysts --> MA[Market Analyst<br/>ê¸°ìˆ ì  ë¶„ì„]
    Analysts --> SA[Social Media Analyst<br/>ê°ì„± ë¶„ì„]
    Analysts --> NA[News Analyst<br/>ë‰´ìŠ¤ ë¶„ì„]
    Analysts --> FA[Fundamentals Analyst<br/>ì¬ë¬´ ë¶„ì„]

    MA --> Reports[Analysis Reports]
    SA --> Reports
    NA --> Reports
    FA --> Reports

    Reports --> InvestDebate{Investment Debate}

    InvestDebate --> Bull[Bull Researcher<br/>ê°•ì„¸ ë¶„ì„ê°€]
    InvestDebate --> Bear[Bear Researcher<br/>ì•½ì„¸ ë¶„ì„ê°€]

    Bull -->|Counter| Bear
    Bear -->|Counter| Bull

    Bull --> RM[Research Manager<br/>íˆ¬ì íŒë‹¨]
    Bear --> RM

    RM -->|Continue Debate| Bull
    RM -->|Decision Made| Trader[Trader<br/>íˆ¬ì ê³„íš ìˆ˜ë¦½]

    Trader --> RiskDebate{Risk Debate}

    RiskDebate --> Risky[Risky Debator<br/>ê³µê²©ì  ì „ëµ]
    RiskDebate --> Neutral[Neutral Debator<br/>ì¤‘ë¦½ì  ì „ëµ]
    RiskDebate --> Safe[Safe Debator<br/>ë³´ìˆ˜ì  ì „ëµ]

    Risky -->|Counter| Neutral
    Neutral -->|Counter| Safe
    Safe -->|Counter| Risky

    Risky --> RiskJudge[Risk Manager<br/>ë¦¬ìŠ¤í¬ íŒë‹¨]
    Neutral --> RiskJudge
    Safe --> RiskJudge

    RiskJudge -->|Continue Debate| Risky
    RiskJudge -->|Final Decision| Final([Final Investment Plan<br/>BUY/HOLD/SELL])

    style Start fill:#667eea,stroke:#333,stroke-width:2px,color:#fff
    style Final fill:#764ba2,stroke:#333,stroke-width:3px,color:#fff
    style MA fill:#4CAF50,color:#fff
    style SA fill:#2196F3,color:#fff
    style NA fill:#FF9800,color:#fff
    style FA fill:#9C27B0,color:#fff
    style Bull fill:#f44336,color:#fff
    style Bear fill:#3f51b5,color:#fff
    style RM fill:#e91e63,color:#fff
    style Trader fill:#00bcd4,color:#fff
    style Risky fill:#ff5722,color:#fff
    style Neutral fill:#607d8b,color:#fff
    style Safe fill:#4caf50,color:#fff
    style RiskJudge fill:#795548,color:#fff
            </div>
        </div>

        <!-- Analyst Agents -->
        <div class="architecture-section">
            <h2>2. Analyst Agents (ë³‘ë ¬ ì‹¤í–‰)</h2>
            <div class="description">
                4ê°œì˜ ë¶„ì„ ì—ì´ì „íŠ¸ê°€ ë…ë¦½ì ìœ¼ë¡œ ì‹œì¥ì„ ë¶„ì„í•©ë‹ˆë‹¤. ê° ì—ì´ì „íŠ¸ëŠ” ì „ë¬¸í™”ëœ ë„êµ¬ì™€ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            </div>

            <div class="mermaid">
graph LR
    subgraph Analysts["Analyst Agents (Parallel Execution)"]
        MA[Market Analyst<br/>ğŸ“ˆ]
        SA[Social Media Analyst<br/>ğŸ’¬]
        NA[News Analyst<br/>ğŸ“°]
        FA[Fundamentals Analyst<br/>ğŸ’°]
    end

    MA --> MR[Market Report<br/>ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„]
    SA --> SR[Sentiment Report<br/>ì†Œì…œ ë¯¸ë””ì–´ ê°ì„±]
    NA --> NR[News Report<br/>ìµœì‹  ë‰´ìŠ¤ ìš”ì•½]
    FA --> FR[Fundamentals Report<br/>ì¬ë¬´ ë°ì´í„° ë¶„ì„]

    MR --> NextStage[Investment Debate Stage]
    SR --> NextStage
    NR --> NextStage
    FR --> NextStage

    style MA fill:#4CAF50,color:#fff
    style SA fill:#2196F3,color:#fff
    style NA fill:#FF9800,color:#fff
    style FA fill:#9C27B0,color:#fff
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="agent-card">
                        <h4>ğŸ“ˆ Market Analyst</h4>
                        <p><strong>ë„êµ¬:</strong> get_stock_data, get_indicators</p>
                        <p><strong>ì—­í• :</strong> 50/200 SMA, MACD, RSI, Bollinger Bands ë“± ê¸°ìˆ ì  ì§€í‘œ ë¶„ì„</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="agent-card">
                        <h4>ğŸ’¬ Social Media Analyst</h4>
                        <p><strong>ë„êµ¬:</strong> get_social_media_sentiment</p>
                        <p><strong>ì—­í• :</strong> Reddit, Twitter ë“± ì†Œì…œ ë¯¸ë””ì–´ì˜ ê°ì„± ë¶„ì„</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="agent-card">
                        <h4>ğŸ“° News Analyst</h4>
                        <p><strong>ë„êµ¬:</strong> get_news</p>
                        <p><strong>ì—­í• :</strong> ìµœì‹  ë‰´ìŠ¤ ìˆ˜ì§‘ ë° ì˜í–¥ ë¶„ì„</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="agent-card">
                        <h4>ğŸ’° Fundamentals Analyst</h4>
                        <p><strong>ë„êµ¬:</strong> get_financial_metrics</p>
                        <p><strong>ì—­í• :</strong> P/E ratio, EPS, Revenue ë“± ì¬ë¬´ ì§€í‘œ ë¶„ì„</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Investment Debate -->
        <div class="architecture-section">
            <h2>3. Investment Debate (ìˆœí™˜ í† ë¡ )</h2>
            <div class="description">
                <strong>Bull vs Bear Debate:</strong> ê°•ì„¸ ë¶„ì„ê°€ì™€ ì•½ì„¸ ë¶„ì„ê°€ê°€ í† ë¡ í•˜ë©°, Research Managerê°€ íŒë‹¨í•©ë‹ˆë‹¤.
                ìµœëŒ€ 100íšŒ ë°˜ë³µ ê°€ëŠ¥ (recursion_limit)
            </div>

            <div class="mermaid">
graph TD
    Start([Analysis Reports]) --> Bull[Bull Researcher<br/>ê°•ì„¸ ì£¼ì¥]
    Bull --> Bear[Bear Researcher<br/>ì•½ì„¸ ì£¼ì¥]
    Bear --> Manager{Research Manager<br/>íˆ¬ì íŒë‹¨}

    Manager -->|"í•©ì˜ ë„ë‹¬"| Decision[Investment Decision<br/>BUY/HOLD/SELL]
    Manager -->|"í† ë¡  ê³„ì†"| Bull

    Decision --> Trader[Trader<br/>íˆ¬ì ê³„íš ìˆ˜ë¦½]

    subgraph Memory["Long-term Memory"]
        BullMem[(Bull Memory)]
        BearMem[(Bear Memory)]
        ManagerMem[(Manager Memory)]
    end

    Bull -.-> BullMem
    Bear -.-> BearMem
    Manager -.-> ManagerMem

    style Bull fill:#f44336,color:#fff
    style Bear fill:#3f51b5,color:#fff
    style Manager fill:#e91e63,color:#fff
    style Trader fill:#00bcd4,color:#fff
            </div>
        </div>

        <!-- Risk Debate -->
        <div class="architecture-section">
            <h2>4. Risk Debate (3-Way í† ë¡ )</h2>
            <div class="description">
                <strong>Risky vs Neutral vs Safe Debate:</strong> 3ê°œì˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì—ì´ì „íŠ¸ê°€ í† ë¡ í•˜ë©°, Risk Managerê°€ ìµœì¢… ê²°ì •í•©ë‹ˆë‹¤.
            </div>

            <div class="mermaid">
graph TD
    Start([Trader's Investment Plan]) --> Safe[Safe Debator<br/>ë³´ìˆ˜ì  ì „ëµ]
    Safe --> Neutral[Neutral Debator<br/>ì¤‘ë¦½ì  ì „ëµ]
    Neutral --> Risky[Risky Debator<br/>ê³µê²©ì  ì „ëµ]

    Risky --> RiskManager{Risk Manager<br/>ë¦¬ìŠ¤í¬ íŒë‹¨}
    Safe --> RiskManager
    Neutral --> RiskManager

    RiskManager -->|"í•©ì˜ ë„ë‹¬"| Final([Final Investment Plan<br/>ìµœì¢… íˆ¬ì ê²°ì •])
    RiskManager -->|"í† ë¡  ê³„ì†"| Safe

    subgraph Memory["Long-term Memory"]
        RiskMem[(Risk Manager Memory)]
    end

    RiskManager -.-> RiskMem

    style Safe fill:#4caf50,color:#fff
    style Neutral fill:#607d8b,color:#fff
    style Risky fill:#ff5722,color:#fff
    style RiskManager fill:#795548,color:#fff
    style Final fill:#764ba2,color:#fff
            </div>
        </div>

        <!-- State Management -->
        <div class="architecture-section">
            <h2>5. State Management</h2>
            <div class="description">
                <strong>LangGraph State:</strong> ëª¨ë“  ì—ì´ì „íŠ¸ ê°„ ì •ë³´ ê³µìœ ë¥¼ ìœ„í•œ ìƒíƒœ ê´€ë¦¬
            </div>

            <div class="mermaid">
classDiagram
    class State {
        +messages: List
        +company_of_interest: str
        +trade_date: str
        +market_report: str
        +sentiment_report: str
        +news_report: str
        +fundamentals_report: str
        +trader_investment_plan: str
        +final_investment_plan: str
        +investment_debate_state: Dict
        +risk_debate_state: Dict
    }

    class InvestmentDebateState {
        +history: List
        +bull_history: List
        +bear_history: List
        +current_response: str
        +judge_decision: str
        +count: int
    }

    class RiskDebateState {
        +history: List
        +risky_history: List
        +neutral_history: List
        +safe_history: List
        +current_risky_response: str
        +current_neutral_response: str
        +current_safe_response: str
        +judge_decision: str
        +count: int
    }

    State --> InvestmentDebateState
    State --> RiskDebateState
            </div>
        </div>

        <!-- Technology Stack -->
        <div class="architecture-section">
            <h2>6. Technology Stack</h2>

            <div class="mermaid">
graph TB
    subgraph Frontend["Frontend Layer"]
        HTML[HTML/CSS/JavaScript]
        SSE[Server-Sent Events]
        Markdown[Marked.js for Rendering]
    end

    subgraph Backend["Backend Layer"]
        Django[Django Views]
        Stream[SSE Streaming]
    end

    subgraph LangGraph["LangGraph Layer"]
        Graph[StateGraph]
        Nodes[Agent Nodes]
        Edges[Conditional Edges]
    end

    subgraph LLM["LLM Layer"]
        Quick[Quick Thinking LLM<br/>gpt-4o-mini]
        Deep[Deep Thinking LLM<br/>gpt-4o]
    end

    subgraph Memory["Memory Layer"]
        BullM[(Bull Memory)]
        BearM[(Bear Memory)]
        TraderM[(Trader Memory)]
        InvestM[(Invest Judge Memory)]
        RiskM[(Risk Manager Memory)]
    end

    subgraph Tools["External Tools"]
        StockAPI[Stock Data API]
        NewsAPI[News API]
        SocialAPI[Social Media API]
        FinAPI[Financial Metrics API]
    end

    HTML --> Django
    Django --> Stream
    Stream --> Graph
    Graph --> Nodes
    Nodes --> Quick
    Nodes --> Deep
    Nodes --> Memory
    Nodes --> Tools

    style Frontend fill:#667eea,color:#fff
    style Backend fill:#764ba2,color:#fff
    style LangGraph fill:#4CAF50,color:#fff
    style LLM fill:#FF9800,color:#fff
    style Memory fill:#2196F3,color:#fff
    style Tools fill:#9C27B0,color:#fff
            </div>
        </div>

        <!-- Back to Main -->
        <div class="text-center mt-5">
            <a href="{% url 'trading_agent:index' %}" class="btn btn-lg"
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 25px;">
                <i class="fas fa-arrow-left"></i> Back to Trading Assistant Agent
            </a>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#764ba2',
                lineColor: '#667eea',
                secondaryColor: '#764ba2',
                tertiaryColor: '#f0f4ff'
            }
        });
    </script>

    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
